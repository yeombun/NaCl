<!DOCTYPE html>
<html lang="ko">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>ğŸŒ¡ï¸ ì—¼ë¶„ë†ë„ì™€ ì˜¨ë„ ëª¨ë‹ˆí„°ë§ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f9f9f9; }
    h1 { color: #1976d2; }
    .container { max-width: 1200px; margin: 0 auto; }
    #alerts { border: 1px solid #d73a49; border-radius: 6px; padding: 10px; margin-bottom: 20px; background: #ffdce0; text-align: left;}
    #alerts h2 { margin-top: 0; color: #d73a49; font-size: 1.2em; }
    .cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .card { border: 2px solid #1976d2; border-radius: 10px; padding: 20px; width: 200px; background: white; }
    .value { font-size: 1.8em; font-weight: bold; margin-top: 10px; }
    #graphs { display: flex; justify-content: space-around; flex-wrap: wrap; }
    .graph { width: 45%; min-width: 350px; }
    .toolbar { margin: 20px 0; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #ddd; display: inline-block; }
    .toolbar input[type="date"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-family: 'Segoe UI', sans-serif; }
    .toolbar button { padding: 6px 12px; border-radius: 4px; border: none; background-color: #1976d2; color: white; cursor: pointer; margin-left: 10px; font-family: 'Segoe UI', sans-serif;}
    .toolbar button:hover { background-color: #1565c0; }
    #clearAlertsBtn { background-color: #d32f2f; }
    #clearAlertsBtn:hover { background-color: #c62828; }
  </style>
</head>
<body>
<div class="container">
  <h1><img src="https://emojicdn.elk.sh/ğŸŒ¡ï¸" style="vertical-align: -0.1em; height: 1em;"> ì—¼ë¶„ë†ë„ì™€ ì˜¨ë„ ëª¨ë‹ˆí„°ë§</h1>
  
  <div id="alerts">
    <h2><img src="https://emojicdn.elk.sh/ğŸš¨" style="vertical-align: -0.1em; height: 1em;"> í˜„ì¬ ë°œìƒí•œ ì•Œë¦¼</h2>
    <ul id="alert-list"><li>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
  </div>

  <div class="toolbar">
    <label for="historyDate">ê³¼ê±° ë°ì´í„° ì¡°íšŒ:</label>
    <input type="date" id="historyDate">
    <button id="loadHistoryBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="realtimeBtn">ì‹¤ì‹œê°„ ê·¸ë˜í”„ë¡œ ì´ˆê¸°í™”</button>
    <button id="exportCsvBtn">Excel (CSV) ì €ì¥</button>
    <button id="clearAlertsBtn">ì•Œë¦¼ ì´ˆê¸°í™”</button>
  </div>

  <div class="cards">
    <div class="card">
      <p><b>ìµœì‹  ìˆ˜ì‹  ì‹œê°„</b></p>
      <div class="value" id="time">-</div>
    </div>
    <div class="card">
      <p><b>ìµœì‹  ì—¼ë¶„ë†ë„</b></p>
      <div class="value" id="conc">- %</div>
    </div>
    <div class="card">
      <p><b>ìµœì‹  ì˜¨ë„</b></p>
      <div class="value" id="temp">- Â°C</div>
    </div>
  </div>

  <div id="graphs">
    <div id="concGraph" class="graph"></div>
    <div id="tempGraph" class="graph"></div>
  </div>
</div>
  
<script>
    // --- 1. ì‚¬ìš©ì ì„¤ì • ---
 const REPO_NAME ="yeombun/NaCl"; 
    // Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ firebaseConfig ê°ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
 const firebaseConfig = {
  apiKey: "AIzaSyAZ87onI6IAsbbDnSOgC_9YeONl4Kk9NwI",
  authDomain: "nacl-monitoring.firebaseapp.com",
  databaseURL: "https://nacl-monitoring-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nacl-monitoring",
  storageBucket: "nacl-monitoring.firebasestorage.app",
  messagingSenderId: "61405500625",
  appId: "1:61405500625:web:bffb394bb1bc4ce04261f0"
};

// Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const sensorRef = database.ref('sensors/cm31p_realtime');

    const MAX_POINTS = 50;
    let realtimeTimeData = [], realtimeConcData = [], realtimeTempData = [];
    let currentGraphData = { times: [], concs: [], temps: [] };
    let isRealtimeMode = true;

 // --- 2. ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ ---
    sensorRef.limitToLast(1).on('child_added', (snapshot) => {
        const data = snapshot.val();
        const ts = new Date(data.timestamp);

        document.getElementById("time").innerText = ts.toLocaleTimeString('ko-KR');
        // document.getElementById("conc").innerText = (data.concentration * 100).toFixed(3) + " %";
        document.getElementById("conc").innerText = data.concentration.toFixed(3) + " %"; 
        document.getElementById("temp").innerText = data.temperature.toFixed(1) + " Â°C";

        realtimeTimeData.push(ts);
      //  realtimeConcData.push(data.concentration * 100);
        realtimeConcData.push(data.concentration);
        realtimeTempData.push(data.temperature);
        if (realtimeTimeData.length > MAX_POINTS) {
            realtimeTimeData.shift(); realtimeConcData.shift(); realtimeTempData.shift();
        }
        
        if (isRealtimeMode) {
           currentGraphData = { times: realtimeTimeData, concs: realtimeConcData, temps: realtimeTempData };
            updateGraphs(realtimeTimeData, realtimeConcData, realtimeTempData, "ì‹¤ì‹œê°„");
        }
    });
    
    function updateGraphs(times, concs, temps, titlePrefix = "") {
        Plotly.newPlot("concGraph", [{x: times, y: concs, type: "scatter", mode: "lines+markers", line: {color: "#2196f3"}}], {title: `${titlePrefix} ì—¼ë¶„ë†ë„ ë³€í™”`, margin: {t: 40}});
        Plotly.newPlot("tempGraph", [{x: times, y: temps, type: "scatter", mode: "lines+markers", line: {color: "#e91e63"}}], {title: `${titlePrefix} ì˜¨ë„ ë³€í™”`, margin: {t: 40}});
    }

    // --- 3. ê³¼ê±° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ---
    const loadHistoryBtn = document.getElementById('loadHistoryBtn');
    const historyDateInput = document.getElementById('historyDate');
    const realtimeBtn = document.getElementById('realtimeBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const clearAlertsBtn = document.getElementById('clearAlertsBtn');
    historyDateInput.valueAsDate = new Date();

    loadHistoryBtn.addEventListener('click', async () => {
        isRealtimeMode = false;
        const selectedDate = historyDateInput.value;
        if (!selectedDate) {
            alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const url = `https://raw.githubusercontent.com/${REPO_NAME}/main/data/log-${selectedDate}.json?t=${new Date().getTime()}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì•„ì§ ë°±ì—…ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            const historicalData = await response.json();
            
            const times = historicalData.map(d => new Date(d.time));
            //const concs = historicalData.map(d => d.conc * 100);
            const concs = historicalData.map(d => d.conc); 
            const temps = historicalData.map(d => d.temp);
            currentGraphData = { times, concs, temps };
            updateGraphs(times, concs, temps, `${selectedDate}`);
            
        } catch (error) {
            alert(error.message);
            console.error("ê³¼ê±° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
        }
    });
    
    realtimeBtn.addEventListener('click', () => {
        isRealtimeMode = true;
        currentGraphData = { times: realtimeTimeData, concs: realtimeConcData, temps: realtimeTempData };
        updateGraphs(realtimeTimeData, realtimeConcData, realtimeTempData, "ì‹¤ì‹œê°„");
    });
//ì—‘ì…€ì €ì¥
      exportCsvBtn.addEventListener('click', () => {
        if (!currentGraphData.times || currentGraphData.times.length === 0) {
            alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // 1. CSV íŒŒì¼ ë‚´ìš© ë§Œë“¤ê¸° (í—¤ë”)
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ BOM ì¶”ê°€
        csvContent += "Timestamp,Concentration (%),Temperature (Â°C)\r\n";

        // 2. í˜„ì¬ ë°ì´í„°ë¡œ CSV ë‚´ìš© ì±„ìš°ê¸°
        for (let i = 0; i < currentGraphData.times.length; i++) {
            const time = currentGraphData.times[i].toLocaleString('sv-SE'); // 'YYYY-MM-DD HH:MM:SS' í˜•ì‹
            const conc = currentGraphData.concs[i];
            const temp = currentGraphData.temps[i];
            csvContent += `${time},${conc},${temp}\r\n`;
        }

        // 3. íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `sensor_data_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    
  
    // --- 4. ì•Œë¦¼ ê¸°ëŠ¥ ---
    const ALERTS_URL = `https://api.github.com/repos/${REPO_NAME}/issues?labels=alert&state=open`;
    async function fetchAlerts() {
        try {
            const response = await fetch(ALERTS_URL);
            const alerts = await response.json();
            const alertList = document.getElementById('alert-list');
            if (alerts && alerts.length > 0) {
                alertList.innerHTML = '';
                alerts.forEach(issue => {
                    const item = document.createElement('li');
                    item.innerHTML = `[#${issue.number}] <a href="${issue.html_url}" target="_blank">${issue.title}</a> (ë°œìƒ: ${new Date(issue.created_at).toLocaleString('ko-KR')})`;
                    alertList.appendChild(item);
                });
            } else {
                alertList.innerHTML = '<li>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            }
        } catch (e) { console.error("ì•Œë¦¼ ë¡œë”© ì‹¤íŒ¨:", e); }
    }
    
    fetchAlerts();
    setInterval(fetchAlerts, 60000);
</script>
</body>
</html>




