<!DOCTYPE html>
<html lang="ko">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>ğŸŒ¡ï¸ CM31P ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f9f9f9; }
    h1 { color: #1976d2; }
    .container { max-width: 1200px; margin: 0 auto; }
    #alerts { border: 1px solid #d73a49; border-radius: 6px; padding: 10px; margin: 20px 0; background: #ffdce0; text-align: left;}
    #alerts h2 { margin-top: 0; color: #d73a49; font-size: 1.2em; }
    .cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .card { border: 2px solid #1976d2; border-radius: 10px; padding: 20px; width: 200px; background: white; }
    .value { font-size: 1.8em; font-weight: bold; margin-top: 10px; }
    #graphs { display: flex; justify-content: space-around; flex-wrap: wrap; }
    .graph { width: 45%; min-width: 350px; }
  </style>
</head>
<body>
<div class="container">
  <h1><img src="https://emojicdn.elk.sh/ğŸŒ¡ï¸" style="vertical-align: -0.1em; height: 1em;"> CM31P ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>

  <div id="alerts">
    <h2><img src="https://emojicdn.elk.sh/ğŸš¨" style="vertical-align: -0.1em; height: 1em;"> í˜„ì¬ ë°œìƒí•œ ì•Œë¦¼</h2>
    <ul id="alert-list"><li>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
  </div>

  <div class="cards">
    <div class="card">
      <p><b>ìµœì‹  ìˆ˜ì‹  ì‹œê°„</b></p>
      <div class="value" id="time">-</div>
    </div>
    <div class="card">
      <p><b>ìµœì‹  ë†ë„</b></p>
      <div class="value" id="conc">- %</div>
    </div>
    <div class="card">
      <p><b>ìµœì‹  ì˜¨ë„</b></p>
      <div class="value" id="temp">- Â°C</div>
    </div>
  </div>

  <div id="graphs">
    <div id="concGraph" class="graph"></div>
    <div id="tempGraph" class="graph"></div>
  </div>
</div>

<script>
    // --- 1. ì‚¬ìš©ì ì„¤ì • ---
    const REPO_NAME = "yeombun/NaCl"; // ë³¸ì¸ GitHub ì €ì¥ì†Œ ì´ë¦„
    // Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ firebaseConfig ê°ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
 const firebaseConfig = {
  apiKey: "AIzaSyAZ87onI6IAsbbDnSOgC_9YeONl4Kk9NwI",
  authDomain: "nacl-monitoring.firebaseapp.com",
  databaseURL: "https://nacl-monitoring-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nacl-monitoring",
  storageBucket: "nacl-monitoring.firebasestorage.app",
  messagingSenderId: "61405500625",
  appId: "1:61405500625:web:bffb394bb1bc4ce04261f0"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
  
    const database = firebase.database();
    const sensorRef = database.ref('sensors/cm31p_realtime');

    const MAX_POINTS = 50;
    let timeData = [], concData = [], tempData = [];

    sensorRef.limitToLast(1).on('child_added', (snapshot) => {
        const data = snapshot.val();
        const ts = new Date(data.timestamp);

        document.getElementById("time").innerText = ts.toLocaleTimeString('ko-KR');
        document.getElementById("conc").innerText = (data.concentration * 100).toFixed(3) + " %";
        document.getElementById("temp").innerText = data.temperature.toFixed(1) + " Â°C";

        timeData.push(ts);
        concData.push(data.concentration * 100);
        tempData.push(data.temperature);
        if (timeData.length > MAX_POINTS) {
            timeData.shift(); concData.shift(); tempData.shift();
        }
        updateGraphs();
    });
    
    function updateGraphs() {
        Plotly.newPlot("concGraph", [{x: timeData, y: concData, type: "scatter", mode: "lines+markers", line: {color: "#2196f3"}}], {title: "ë†ë„ ë³€í™”", margin: {t: 40}});
        Plotly.newPlot("tempGraph", [{x: timeData, y: tempData, type: "scatter", mode: "lines+markers", line: {color: "#e91e63"}}], {title: "ì˜¨ë„ ë³€í™”", margin: {t: 40}});
    }

    const ALERTS_URL = `https://api.github.com/repos/${REPO_NAME}/issues?labels=alert&state=open`;
    async function fetchAlerts() {
        try {
            const response = await fetch(ALERTS_URL);
            const alerts = await response.json();
            const alertList = document.getElementById('alert-list');
            if (alerts && alerts.length > 0) {
                alertList.innerHTML = '';
                alerts.forEach(issue => {
                    const item = document.createElement('li');
                    item.innerHTML = `[#${issue.number}] <a href="${issue.html_url}" target="_blank">${issue.title}</a> (ë°œìƒ: ${new Date(issue.created_at).toLocaleString('ko-KR')})`;
                    alertList.appendChild(item);
                });
            } else {
                alertList.innerHTML = '<li>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            }
        } catch (e) { console.error("ì•Œë¦¼ ë¡œë”© ì‹¤íŒ¨:", e); }
    }
    
    fetchAlerts();
    setInterval(fetchAlerts, 60000);
</script>
</body>
</html>
