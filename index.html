<!DOCTYPE html>
<html lang="ko">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>🌡️ CM31P 실시간 대시보드</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f9f9f9; }
    h1 { color: #1976d2; }
    .container { max-width: 1200px; margin: 0 auto; }
    #alerts { border: 1px solid #d73a49; border-radius: 6px; padding: 10px; margin-bottom: 20px; background: #ffdce0; text-align: left;}
    #alerts h2 { margin-top: 0; color: #d73a49; font-size: 1.2em; }
    .cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .card { border: 2px solid #1976d2; border-radius: 10px; padding: 20px; width: 200px; background: white; }
    .value { font-size: 1.8em; font-weight: bold; margin-top: 10px; }
    #graphs { display: flex; justify-content: space-around; flex-wrap: wrap; }
    .graph { width: 45%; min-width: 350px; }
    .toolbar { margin: 20px 0; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #ddd; display: inline-block; }
    .toolbar input[type="date"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-family: 'Segoe UI', sans-serif; }
    .toolbar button { padding: 6px 12px; border-radius: 4px; border: none; background-color: #1976d2; color: white; cursor: pointer; margin-left: 10px; font-family: 'Segoe UI', sans-serif;}
    .toolbar button:hover { background-color: #1565c0; }
  </style>
</head>
<body>
<div class="container">
  <h1><img src="https://emojicdn.elk.sh/🌡️" style="vertical-align: -0.1em; height: 1em;"> CM31P 실시간 모니터링</h1>
  
  <div id="alerts">
    <h2><img src="https://emojicdn.elk.sh/🚨" style="vertical-align: -0.1em; height: 1em;"> 현재 발생한 알림</h2>
    <ul id="alert-list"><li>알림을 불러오는 중...</li></ul>
  </div>

  <div class="toolbar">
    <label for="historyDate">과거 데이터 조회:</label>
    <input type="date" id="historyDate">
    <button id="loadHistoryBtn">불러오기</button>
    <button id="realtimeBtn">실시간 데이터 보기</button>
  </div>

  <div class="cards">
    <div class="card">
      <p><b>최신 수신 시간</b></p>
      <div class="value" id="time">-</div>
    </div>
    <div class="card">
      <p><b>최신 농도</b></p>
      <div class="value" id="conc">- %</div>
    </div>
    <div class="card">
      <p><b>최신 온도</b></p>
      <div class="value" id="temp">- °C</div>
    </div>
  </div>

  <div id="graphs">
    <div id="concGraph" class="graph"></div>
    <div id="tempGraph" class="graph"></div>
  </div>
</div>

<script>
    // --- 1. 사용자 설정 ---
 const REPO_NAME ="yeombun/NaCl"; // 본인 GitHub 저장소 이름
    // Firebase 콘솔에서 복사한 firebaseConfig 객체를 여기에 붙여넣으세요.
 const firebaseConfig = {
  apiKey: "AIzaSyAZ87onI6IAsbbDnSOgC_9YeONl4Kk9NwI",
  authDomain: "nacl-monitoring.firebaseapp.com",
  databaseURL: "https://nacl-monitoring-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nacl-monitoring",
  storageBucket: "nacl-monitoring.firebasestorage.app",
  messagingSenderId: "61405500625",
  appId: "1:61405500625:web:bffb394bb1bc4ce04261f0"
};

// Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const sensorRef = database.ref('sensors/cm31p_realtime');

    const MAX_POINTS = 50;
    let realtimeTimeData = [], realtimeConcData = [], realtimeTempData = [];
    let isRealtimeMode = true;

 // --- 2. 실시간 데이터 처리 ---
    sensorRef.limitToLast(1).on('child_added', (snapshot) => {
        const data = snapshot.val();
        const ts = new Date(data.timestamp);

        document.getElementById("time").innerText = ts.toLocaleTimeString('ko-KR');
        document.getElementById("conc").innerText = (data.concentration * 100).toFixed(3) + " %";
        document.getElementById("temp").innerText = data.temperature.toFixed(1) + " °C";

        realtimeTimeData.push(ts);
        realtimeConcData.push(data.concentration * 100);
        realtimeTempData.push(data.temperature);
        if (realtimeTimeData.length > MAX_POINTS) {
            realtimeTimeData.shift(); realtimeConcData.shift(); realtimeTempData.shift();
        }
        
        if (isRealtimeMode) {
            updateGraphs(realtimeTimeData, realtimeConcData, realtimeTempData, "실시간");
        }
    });
    
    function updateGraphs(times, concs, temps, titlePrefix = "") {
        Plotly.newPlot("concGraph", [{x: times, y: concs, type: "scatter", mode: "lines+markers", line: {color: "#2196f3"}}], {title: `${titlePrefix} 농도 변화`, margin: {t: 40}});
        Plotly.newPlot("tempGraph", [{x: times, y: temps, type: "scatter", mode: "lines+markers", line: {color: "#e91e63"}}], {title: `${titlePrefix} 온도 변화`, margin: {t: 40}});
    }

    // --- 3. 과거 데이터 불러오기 기능 ---
    const loadHistoryBtn = document.getElementById('loadHistoryBtn');
    const historyDateInput = document.getElementById('historyDate');
    const realtimeBtn = document.getElementById('realtimeBtn');

    historyDateInput.valueAsDate = new Date();

    loadHistoryBtn.addEventListener('click', async () => {
        isRealtimeMode = false;
        const selectedDate = historyDateInput.value;
        if (!selectedDate) {
            alert('날짜를 선택해주세요.');
            return;
        }
        
        const url = `https://raw.githubusercontent.com/${REPO_NAME}/main/data/log-${selectedDate}.json?t=${new Date().getTime()}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('데이터 파일을 찾을 수 없습니다. 해당 날짜에 데이터가 없거나 아직 백업되지 않았을 수 있습니다.');
            }
            const historicalData = await response.json();
            
            const times = historicalData.map(d => new Date(d.time));
            const concs = historicalData.map(d => d.conc * 100);
            const temps = historicalData.map(d => d.temp);
            
            updateGraphs(times, concs, temps, `${selectedDate}`);
            
        } catch (error) {
            alert(error.message);
            console.error("과거 데이터 로딩 실패:", error);
        }
    });
    
    realtimeBtn.addEventListener('click', () => {
        isRealtimeMode = true;
        updateGraphs(realtimeTimeData, realtimeConcData, realtimeTempData, "실시간");
    });

    // --- 4. 알림 기능 ---
    const ALERTS_URL = `https://api.github.com/repos/${REPO_NAME}/issues?labels=alert&state=open`;
    async function fetchAlerts() {
        try {
            const response = await fetch(ALERTS_URL);
            const alerts = await response.json();
            const alertList = document.getElementById('alert-list');
            if (alerts && alerts.length > 0) {
                alertList.innerHTML = '';
                alerts.forEach(issue => {
                    const item = document.createElement('li');
                    item.innerHTML = `[#${issue.number}] <a href="${issue.html_url}" target="_blank">${issue.title}</a> (발생: ${new Date(issue.created_at).toLocaleString('ko-KR')})`;
                    alertList.appendChild(item);
                });
            } else {
                alertList.innerHTML = '<li>새로운 알림이 없습니다.</li>';
            }
        } catch (e) { console.error("알림 로딩 실패:", e); }
    }
    
    fetchAlerts();
    setInterval(fetchAlerts, 60000);
</script>
</body>
</html>
